---
# Base OS preparation and hardening
- name: Assert mailserver_user is defined
  ansible.builtin.assert:
    that:
      - mailserver_user is defined
      - mailserver_user | length > 0
    fail_msg: "Required variable 'mailserver_user' must be defined and non-empty. Please check vars/main.example for reference."

- name: Assert mailserver_user_public_key is defined
  ansible.builtin.assert:
    that:
      - mailserver_user_public_key is defined
      - mailserver_user_public_key | length > 0
    fail_msg: "Required variable 'mailserver_user_public_key' must be defined and non-empty. Please check vars/secrets.example for reference."

- name: Set hostname
  hostname:
    name: "{{ mail_hostname }}"

- name: Ensure /etc/hosts has FQDN
  lineinfile:
    path: /etc/hosts
    line: "{{ ansible_host }} {{ mail_hostname }} mail"
    state: present

- name: Update apt cache and upgrade
  apt:
    update_cache: yes
    upgrade: dist

- name: Install base packages
  apt:
    name:
      - curl
      - wget
      - gnupg
      - lsb-release
      - ca-certificates
      - ufw
      - fail2ban
      - logrotate
      - auditd
    state: present

- name: Install and enable chrony
  apt:
    name: chrony
    state: present

- name: Ensure chrony is running
  service:
    name: chrony
    state: started
    enabled: true

- name: Set timezone to Africa/Lagos (GMT+1)
  timezone:
    name: Africa/Lagos

# Task to create mailserver user
- name: Create mailserver user
  ansible.builtin.user:
    name: "{{ mailserver_user }}"
    state: present
    shell: /bin/bash

# Task to add the user's public key to the server
- name: Add authorized key for mailserver user
  ansible.builtin.authorized_key:
    user: "{{ mailserver_user }}"
    state: present
    key: "{{ mailserver_user_public_key }}"

# Task to add the user to sudoers
- name: Add mailserver user to sudoers
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: "^{{ mailserver_user }}"
    line: "{{ mailserver_user }} ALL=(ALL) NOPASSWD:ALL"
    validate: "visudo -cf %s"
